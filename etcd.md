# 简介

etcd 是一个分布式键值对存储，设计用来可靠而快速的保存关键数据并提供访问。通过分布式锁，leader选举和写屏障(write barriers)来实现可靠的分布式协作。etcd集群是为高可用，持久性数据存储和检索而准备。

Etcd 是 CoreOS 基于 Raft 协议开发的分布式 key-value 存储，可用于服务发现、共享配置以及一致性保障（如数据库选主、分布式锁等）。

# 提供能力

Etcd 主要提供以下能力

- 提供存储以及获取数据的接口，它通过协议保证 Etcd 集群中的多个节点数据的强一致性。用于存储元信息以及共享配置。
- 提供监听机制，客户端可以监听某个key或者某些key的变更（v2和v3的机制不同，参看后面文章）。用于监听和推送变更。
- 提供key的过期以及续约机制，客户端通过定时刷新来实现续约（v2和v3的实现机制也不一样）。用于集群监控以及服务注册发现。
- 提供原子的CAS（Compare-and-Swap）和 CAD（Compare-and-Delete）支持（v2通过接口参数实现，v3通过批量事务实现）。用于分布式锁以及leader选举。

etcd可以扮演两大角色：

持久化的键值存储系统 分布式系统数据一致性服务提供者

# 名词

| 术语             | 描述                                                         |
| ---------------- | ------------------------------------------------------------ |
| Node（节点）     | Node（节点） 是 raft 状态机的一个实例。它有唯一标识，如果它是leader，会内部记录其他节点的信息。 |
| Member（成员）   | Member（成员是） etcd 的一个实例。它承载一个 node/节点，并为 client （客户端）提供服务。 |
| Cluster（集群）  | Cluster（集群）由多个　member（成员）组成。每个成员的节点遵循 raft 一致性协议来复制日志。集群从成员中接收提案，提交他们并应用到本地存储。 |
| Peer（同伴）     | Peer（同伴）是同一个集群中的其他成员。                       |
| Proposal（提议） | 提议是一个需要完成　raft　协议的请求（例如写请求，配置修改请求）。 |
| Client（客户端） | Client（客户端）是集群　HTTP API 的调用者。对于 V3 版本，应该包括 gRPC API。 |
| Machine（机器）  | 该术语已弃用。在 2.0 版本之前，在　etcd　中的成员备选。      |
| etcd HTTP Server | 用于处理用户发送的 API 请求以及其它 etcd 节点的同步与心跳信息请求。 |
| etcd Store       | 用于处理 etcd 支持的各类功能的事务，包括数据索引、节点状态变更、监控与反馈、事件处理与执行等等，是 etcd 对用户提供的大多数 API 功能的具体实现。 |
| Raft             | Raft 强一致性算法的具体实现，是 etcd 的核心。                |
| WAL              | Write Ahead Log（预写式日志），是 etcd 的数据存储方式。除了在内存中存有所有数据的状态以及节点的索引以外，etcd 就通过 WAL 进行持久化存储。WAL 中， 所有的数据提交前都会事先记录日志。Snapshot 是为了防止数据过多而进行的状态快照；Entry 表示存储的具体日志内容。 |

# Etcd，Zookeeper，Consul 比较

Etcd 和 Zookeeper 提供的能力非常相似，都是通用的一致性元信息存储，都提供watch机制用于变更通知和分发，也都被分布式系统用来作为共享信息存储，在软件生态中所处的位置也几乎是一样的，原则上可以互相替代的。